# E2E Tests

End-to-end tests that verify the full processing pipeline from input to show note generation.

## Outline

- [Running Tests](#running-tests)
  - [All E2E Tests](#all-e2e-tests)
  - [Run Specific Tests by Path](#run-specific-tests-by-path)
  - [Run Tests with Input Variants](#run-tests-with-input-variants)
- [Available Input Variants](#available-input-variants)
- [Run Tests with Glob Patterns](#run-tests-with-glob-patterns)
- [Filtered Tests by Tag](#filtered-tests-by-tag)
- [Common Test Commands by Content Type](#common-test-commands-by-content-type)
  - [Transcription Tests](#transcription-tests-14-base-files)
  - [LLM Tests](#llm-tests-10-base-files)
  - [Document Tests](#document-tests-5-base-files)
- [How E2E Tests Work](#how-e2e-tests-work)
- [Timeouts](#timeouts)

## Running Tests

### All E2E Tests

```bash
bun test tests/e2e.test.ts
```

### Run Specific Tests by Path

Run any arbitrary tests by passing their JSON definition paths directly:

```bash
bun e2e tests/test-definitions/verify/verify-transcription-fal.json tests/test-definitions/verify/verify-transcription-gladia.json
```

### Run Tests with Input Variants

Use the `--input` flag to specify input size/type variants for transcription, LLM, and document tests:

```bash
# Run transcription test with 1-minute local audio (default)
bun e2e tests/test-definitions/transcription/transcription-fal.json

# Run with explicit input variant
bun e2e --input 1m-local tests/test-definitions/transcription/transcription-fal.json

# Run with 10-minute direct URL audio
bun e2e --input 10m-direct tests/test-definitions/transcription/transcription-fal.json

# Run multiple variants (creates 2 tests from 1 file)
bun e2e --input 1m-local,10m-direct tests/test-definitions/transcription/transcription-fal.json

# Run all LLM tests with 5-minute audio
bun e2e --input 5m-local 'tests/test-definitions/llm/*.json'

# Run document test with 3-page local PDF
bun e2e --input 3p-local tests/test-definitions/document/document-llamaparse-agentic.json
```

## Available Input Variants

| Category | Variant      | Type  | Source                                       |
|----------|--------------|-------|----------------------------------------------|
| Audio    | `1m-local`   | local | `tests/test-input-files/1.mp3`               |
| Audio    | `1m-direct`  | url   | `https://ajc.pics/autoshow/1.mp3`            |
| Audio    | `5m-local`   | local | `tests/test-input-files/5.mp3`               |
| Audio    | `5m-direct`  | url   | `https://ajc.pics/autoshow/5.mp3`            |
| Audio    | `10m-direct` | url   | `https://ajc.pics/autoshow/10.mp3`           |
| Audio    | `20m-direct` | url   | `https://ajc.pics/autoshow/20.mp3`           |
| Document | `1p-local`   | local | `tests/test-input-files/1.pdf`               |
| Document | `1p-direct`  | url   | `https://ajc.pics/autoshow/textract-1.pdf`   |
| Document | `3p-local`   | local | `tests/test-input-files/3.pdf`               |
| Document | `10p-direct` | url   | `https://ajc.pics/autoshow/textract-10.pdf`  |

## Run Tests with Glob Patterns

Use glob patterns to run groups of tests matching a pattern:

```bash
# All transcription tests with default input
bun e2e 'tests/test-definitions/transcription/*.json'

# All groq transcription tests
bun e2e 'tests/test-definitions/transcription/*-groq-*.json'

# All OpenAI LLM tests
bun e2e 'tests/test-definitions/llm/*-openai-*.json'

# All LlamaParse document tests
bun e2e 'tests/test-definitions/document/*-llamaparse-*.json'
```

## Filtered Tests by Tag

The test runner supports filtering by tags. Tests can have multiple tags like `["verify", "llm", "openai", "minimal"]`. When multiple tags are provided, tests must match ALL tags (AND logic).

```bash
# Run all transcription tests
bun test tests/e2e.test.ts -- transcription

# Run all OpenAI tests
bun test tests/e2e.test.ts -- openai

# Run all image generation tests
bun test tests/e2e.test.ts -- image

# Run only minimal/verification tests
bun test tests/e2e.test.ts -- minimal

# Run verify-base cost-targeted suite
bun test tests/e2e.test.ts -- verify-base
```

## Common Test Commands by Content Type

### Transcription Tests (14 base files)

| Command                                                                              | Tests | Description                         |
|--------------------------------------------------------------------------------------|-------|-------------------------------------|
| `bun e2e 'tests/test-definitions/transcription/*.json'`                              | 14    | All services, default input         |
| `bun e2e --input 1m-local 'tests/test-definitions/transcription/*.json'`             | 14    | All services, 1-minute local audio  |
| `bun e2e --input 5m-local 'tests/test-definitions/transcription/*.json'`             | 14    | All services, 5-minute local audio  |
| `bun e2e --input 10m-direct 'tests/test-definitions/transcription/*.json'`           | 14    | All services, 10-minute direct URL  |
| `bun e2e --input 20m-direct 'tests/test-definitions/transcription/*.json'`           | 14    | All services, 20-minute direct URL  |
| `bun e2e --input 1m-local,10m-direct 'tests/test-definitions/transcription/*.json'`  | 28    | All services, both variants         |

### LLM Tests (10 base files)

| Command                                                               | Tests | Description                         |
|-----------------------------------------------------------------------|-------|-------------------------------------|
| `bun e2e 'tests/test-definitions/llm/*.json'`                         | 10    | All models, default input           |
| `bun e2e --input 1m-local 'tests/test-definitions/llm/*.json'`        | 10    | All models, 1-minute local audio    |
| `bun e2e --input 5m-local 'tests/test-definitions/llm/*.json'`        | 10    | All models, 5-minute local audio    |
| `bun e2e --input 10m-direct 'tests/test-definitions/llm/*.json'`      | 10    | All models, 10-minute direct URL    |
| `bun e2e --input 20m-direct 'tests/test-definitions/llm/*.json'`      | 10    | All models, 20-minute direct URL    |
| `bun e2e 'tests/test-definitions/llm/*-openai-*.json'`                | 3     | All OpenAI models                   |
| `bun e2e 'tests/test-definitions/llm/*-claude-*.json'`                | 3     | All Claude models                   |
| `bun e2e 'tests/test-definitions/llm/*-gemini-*.json'`                | 2     | All Gemini models                   |

### Document Tests (5 base files)

| Command                                                               | Tests | Description                         |
|-----------------------------------------------------------------------|-------|-------------------------------------|
| `bun e2e 'tests/test-definitions/document/*.json'`                    | 5     | All parsers, default input          |
| `bun e2e --input 1p-direct 'tests/test-definitions/document/*.json'`  | 5     | All parsers, 1-page direct URL      |
| `bun e2e --input 3p-local 'tests/test-definitions/document/*.json'`   | 5     | All parsers, 3-page local PDF       |
| `bun e2e --input 10p-direct 'tests/test-definitions/document/*.json'` | 5     | All parsers, 10-page direct URL     |
| `bun e2e 'tests/test-definitions/document/*-llamaparse-*.json'`       | 4     | All LlamaParse tests                |

### TTS, Image, Music Tests

| Command                                          | Tests | Description                  |
|--------------------------------------------------|-------|------------------------------|
| `bun e2e 'tests/test-definitions/tts/*.json'`    | 3     | All TTS tests                |
| `bun e2e 'tests/test-definitions/image/*.json'`  | 9     | All image generation tests   |
| `bun e2e 'tests/test-definitions/music/*.json'`  | 3     | All music generation tests   |

## How E2E Tests Work

1. **Build** the application with `bun run vinxi build`
2. **Start** the server with `bun run vinxi start`
3. **Wait** for health check to pass
4. **Load** JSON test definitions matching filter patterns
5. **Execute** each test:
   - Upload file or provide URL
   - Submit processing job
   - Poll until completion
   - Verify show note page is generated
6. **Stop** the server
7. **Generate** JSON report in `logs/`

## Timeouts

| Operation       | Timeout    |
|-----------------|------------|
| Server setup    | 10 minutes |
| Individual test | 1 hour     |
| Job polling     | 1 hour     |
