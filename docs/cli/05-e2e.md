# E2E Testing

Run end-to-end tests in an isolated Docker container.

## Outline

- [Usage](#usage)
- [What It Does](#what-it-does)
- [Requirements](#requirements)
- [Test Suites](#test-suites)
  - [Health Tests](#health-tests)
  - [Verification Tests](#verification-tests)
  - [E2E Tests](#e2e-tests)
- [Test Structure](#test-structure)
- [Writing Tests](#writing-tests)
- [Test Commands](#test-commands)
- [Continuous Integration](#continuous-integration)
- [Troubleshooting](#troubleshooting)
  - [Tests timeout](#tests-timeout)
  - [API keys missing](#api-keys-missing)
  - [Container issues](#container-issues)

## Usage

```bash
bun as e2e
```

## What It Does

1. Spins up isolated Docker container
2. Creates fresh SQLite database
3. Runs HTTP requests against API endpoints
4. Verifies full processing pipeline
5. Cleans up container after tests

## Requirements

Valid API keys in `.env`:
```bash
GROQ_API_KEY=your_key_here
OPENAI_API_KEY=your_key_here
```

## Test Suites

### Health Tests
```bash
bun test tests/health.test.ts
```

Verifies:
- `/api/health` endpoint responds
- Basic server functionality

### Verification Tests
```bash
bun test tests/verify.test.ts
```

Verifies:
- All transcription models
- All LLM models
- Service connectivity

### E2E Tests
```bash
bun test tests/e2e.test.ts
```

Verifies:
- Complete processing pipeline
- Multi-step job orchestration
- Error handling
- Progress tracking

### API Tests
```bash
bun test tests/api/
```

Individual API endpoint tests.

## Test Structure

```
tests/
├── test-definitions/      # JSON test configurations
├── test-input-files/      # Fixture files (audio, video, PDFs)
├── test-runner/           # Test execution infrastructure
├── health.test.ts         # Health endpoint
├── verify.test.ts         # Model verification
├── e2e.test.ts           # Full pipeline tests
└── api/                   # API endpoint tests
```

## Writing Tests

```typescript
import { test, expect, describe } from "bun:test"

const BASE_URL = process.env.BASE_URL || "http://localhost:4321"

describe("my feature", () => {
  test("does something", async () => {
    const response = await fetch(`${BASE_URL}/api/endpoint`)
    expect(response.status).toBe(200)
    const data = await response.json()
    expect(data.success).toBe(true)
  })
})
```

## Test Commands

```bash
bun test                    # All tests
bun test tests/health.test.ts  # Single file
bun test --watch            # Watch mode
bun test -t "pattern"       # Pattern matching
```

## Continuous Integration

Tests run automatically on:
- Pull requests
- Pushes to main branch
- Nightly builds

See `.github/workflows/` for CI configuration.

## Troubleshooting

### Tests timeout
Increase timeout in test file:
```typescript
test("slow operation", async () => {
  // test code
}, { timeout: 60000 })
```

### API keys missing
Ensure `.env` file has required keys:
```bash
bun as config
```

### Container issues
Clean up and retry:
```bash
bun as prune
bun as e2e
```
